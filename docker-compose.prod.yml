# Production Docker Compose Override
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

version: '3.8'

services:
  # Production MySQL with persistent storage and security
  mysql:
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - /var/lib/mysql-data:/var/lib/mysql  # Use host path for production

  # Redis with password protection
  redis:
    command: redis-server --requirepass ${REDIS_PASSWORD}
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}

  # User Service - Production Settings
  user-service:
    environment:
      SPRING_PROFILES_ACTIVE: prod
      JAVA_OPTS: -Xms512m -Xmx2048m -XX:+UseG1GC
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # Booking Service - Production Settings
  booking-service:
    environment:
      SPRING_PROFILES_ACTIVE: prod
      JAVA_OPTS: -Xms512m -Xmx2048m -XX:+UseG1GC
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

  # Ride Service - Production Settings
  ride-service:
    environment:
      SPRING_PROFILES_ACTIVE: prod
      JAVA_OPTS: -Xms512m -Xmx2048m -XX:+UseG1GC
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

  # Vehicle Service - Production Settings
  vehicle-service:
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      DOTNET_SYSTEM_GLOBALIZATION_INVARIANT: false
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

  # API Gateway - Production Settings
  api-gateway:
    environment:
      SPRING_PROFILES_ACTIVE: prod
      JAVA_OPTS: -Xms256m -Xmx1024m -XX:+UseG1GC
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

  # Frontend - Production Settings
  frontend:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
